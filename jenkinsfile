def PIPELINE_START = 0
def DEPLOY_END  = 0

pipeline {
    agent any

    stages {

        stage('Source') {
            steps {
                script {
                    PIPELINE_START = System.currentTimeMillis()
                    echo "Source stage started at ${PIPELINE_START}"
                }
            }
        }

        stage('Build') {
            steps {
                sh '''
                  echo "Building artifact..."
                  mkdir -p build
                  cp -r index.html assets vendor build/
                '''
            }
        }

        stage('Test') {
            steps {
                sh '''
                  echo "Running basic test..."
                  test -f build/index.html
                '''
            }
        }

        stage('Deploy') {
            steps {
                sh '''
                  echo "Deploying to Nginx..."
                  sudo rm -rf /var/www/html/*
                  sudo cp -r build/* /var/www/html/
                '''
                script {
                    DEPLOY_END = System.currentTimeMillis()
                }
            }
        }
    }

    post {
        success {
            script {
                def leadTime = DEPLOY_END - PIPELINE_START
                echo "Pipepine Start = $(pipeline_start)"
                echo "Pipepine Start = $(deploy_end)"
                echo "üìä Lead Time for Change (ms): ${leadTime}"
                echo "‚úÖ Deployment SUCCESS (counted in DORA metric)"
            }
        }

        failure {
            echo "‚ùå Pipeline FAILED ‚Äì deployment NOT counted in DORA"
        }
    }
}
