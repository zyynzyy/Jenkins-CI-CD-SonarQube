pipeline {
    agent any

    environment {
        START_TIME = "${System.currentTimeMillis()}"
    }

    stages {

        stage('Source') {
            steps {
                script {
                    env.SOURCE_TIME = System.currentTimeMillis()
                }
                echo "Source stage started at ${env.SOURCE_TIME}"
            }
        }

        stage('Build') {
            steps {
                script {
                    env.BUILD_START = System.currentTimeMillis()
                }
                sh '''
                  mkdir -p build
                  cp -r index assets vendor build/
                '''
                script {
                    env.BUILD_END = System.currentTimeMillis()
                }
            }
        }

        stage('Test') {
            steps {
                script {
                    env.TEST_START = System.currentTimeMillis()
                }
                sh '''
                  test -f build/index || exit 1
                '''
                script {
                    env.TEST_END = System.currentTimeMillis()
                }
            }
        }

        stage('Deploy') {
            steps {
                script {
                    env.DEPLOY_START = System.currentTimeMillis()
                }
                sh '''
                  sudo rm -rf /var/www/html/*
                  sudo cp -r build/* /var/www/html/
                '''
                script {
                    env.DEPLOY_END = System.currentTimeMillis()
                }
            }
        }
    }

    post {
        always {
            script {
                def leadTime = env.DEPLOY_END.toLong() - env.SOURCE_TIME.toLong()
                echo "üìä Lead Time for Change (ms): ${leadTime}"
            }
        }
        success {
            echo "‚úÖ Deployment SUCCESS (count this as 1 deployment)"
        }
        failure {
            echo "‚ùå Deployment FAILED (do NOT count)"
        }
    }
}
