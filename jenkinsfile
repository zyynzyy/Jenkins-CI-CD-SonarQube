pipeline {
    agent any

    environment {
        SOURCE_TIME = ""
        DEPLOY_END  = ""
    }

    stages {

        stage('Source') {
            steps {
                script {
                    env.SOURCE_TIME = System.currentTimeMillis()
                }
                echo "Source stage started at ${env.SOURCE_TIME}"
            }
        }

        stage('Build') {
            steps {
                sh '''
                  echo "Building artifact..."
                  mkdir -p build
                  cp -r website/* build/
                '''
            }
        }

        stage('Test') {
            steps {
                sh '''
                  echo "Running basic test..."
                  test -f build/index.html
                '''
            }
        }

        stage('Deploy') {
            steps {
                sh '''
                  echo "Deploying to Nginx..."
                  sudo rm -rf /var/www/html/*
                  sudo cp -r build/* /var/www/html/
                '''
                script {
                    env.DEPLOY_END = System.currentTimeMillis()
                }
            }
        }
    }

    post {
        success {
            script {
                def leadTime = env.DEPLOY_END.toLong() - env.SOURCE_TIME.toLong()
                echo "üìä Lead Time for Change (ms): ${leadTime}"
                echo "‚úÖ Deployment SUCCESS (count as 1 deployment)"
            }
        }

        failure {
            echo "‚ùå Pipeline FAILED ‚Äì deployment not counted"
        }
    }
}
