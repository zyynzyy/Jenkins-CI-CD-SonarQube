pipeline {
    agent any

    options {
        timestamps()
    }

    stages {

        stage('Pull Source Code') {
            steps {
                echo "Pulling source code from GitHub"
                checkout scm
            }
        }

        stage('Update Server') {
            steps {
                echo "Running apt update"
                sh '''
                    sudo apt update -y
                '''
            }
        }

        stage('Install Nginx') {
            steps {
                echo "Installing nginx"
                sh '''
                    if ! command -v nginx > /dev/null; then
                        sudo apt install nginx -y
                    else
                        echo "Nginx already installed"
                    fi
                '''
            }
        }

        stage('Deploy Website to Nginx') {
            steps {
                echo "Deploying static website to nginx"
                sh '''
                    sudo rm -rf /var/www/html/*
                    sudo cp -r index assets vendor /var/www/html/

                    sudo chown -R www-data:www-data /var/www/html
                    sudo chmod -R 755 /var/www/html

                    sudo systemctl restart nginx
                '''
            }
        }
    }

    post {
        success {
            echo "✅ Deployment SUCCESS - Website is live on Nginx"
        }
        failure {
            echo "❌ Deployment FAILED"
        }
    }
}
